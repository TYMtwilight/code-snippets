# セッションとクッキー

> **学習日:** 2026-02-21

---

## 🎯 何のための概念か？

HTTPはステートレスなプロトコルのため、リクエストをまたいでユーザーの状態を保持できない。セッションとクッキーはこの問題を解決し、「誰が何をしたか」をサーバーまたはブラウザに記憶させるための仕組み。

---

## 📚 要点

### この概念を一言で

- **クッキー** = ブラウザにデータをそのまま保存する仕組み
- **セッション** = サーバー側にデータを保存し、IDだけをクッキーで渡す仕組み

### 重要ポイント

1. HTTPはステートレスなので、リクエストをまたいで状態を維持するには別の仕組みが必要
2. セッションはクッキーを「IDの運搬手段」として利用している（セッション ⊃ クッキー）
3. ブラウザが持つのはセッションIDだけで、実データはサーバー側にある

---

## ⚠️ 注意点

### よくある誤解

- ❌ セッション = ログイン〜ログアウトの期間のこと
  - ✅ セッションはログイン前（匿名状態）でも存在する。ログインはセッションに認証情報を付与する操作に過ぎない
- ❌ セッションとクッキーは別々の独立した仕組み
  - ✅ セッションはIDの受け渡しにクッキーを利用しており、クッキーに依存している

### 気をつけるべきこと

- セッションが終わる条件はログアウトだけでなく、タイムアウト・ブラウザを閉じる・サーバー再起動なども含む
- クッキーに保存したデータはユーザーが閲覧・改ざん可能なため、センシティブな情報は入れない

---

## 💡 理解のポイント

### クッキーの仕組み

```
サーバー → ブラウザ: Set-Cookie: username=taro; theme=dark
ブラウザ → サーバー: Cookie: username=taro; theme=dark  （次回以降自動送信）
```

データをブラウザに丸ごと保存。ユーザーが中身を見たり改ざんしたりできる。

### セッションの仕組み

```
サーバー → ブラウザ: Set-Cookie: session_id=abc123   ← IDだけ渡す
サーバー側:          { abc123: { username=taro, role=admin } }  ← 本体はサーバー
ブラウザ → サーバー: Cookie: session_id=abc123   ← IDを提示
```

IDを手がかりにサーバー側のデータを参照するため、ブラウザ側での改ざんが不可能。

### セッションのライフサイクル

```
初回アクセス → セッション生成（IDを発行）
     ↓
ログイン → セッションに認証情報を付与
     ↓
操作中 → セッションに状態を記録
     ↓
ログアウト / タイムアウト / ブラウザを閉じる → セッション破棄
```

### いつ使うか？

- ✅ セッション：ログイン状態・権限情報など改ざんされると困る情報
- ✅ クッキー：テーマ・言語設定など漏れても問題ない情報

### いつ使わないか？

- ❌ クッキー：パスワード・権限など機密性の高い情報
- ❌ セッション（インメモリ）：サーバー再起動で消えるため、永続化が必要な情報

### 類似概念との違い

| 項目 | クッキー | セッション |
|------|---------|-----------|
| データの保存場所 | ブラウザ（クライアント） | サーバー |
| ブラウザが持つもの | データ本体 | IDのみ |
| 改ざんのリスク | 高い | 低い（IDの偽造対策は別途必要） |
| サーバーの負荷 | 低い | 高い（サーバーがデータを保持） |
| 有効期限の管理 | クッキー自体に設定 | サーバー側で管理 |

---

## 🔗 関連

- **関連概念:** [認証クッキー vs CSRFトークン](csrf-token-vs-auth-cookie.md)
- **関連概念:** [Spring Security - UserDetailsService](../spring/security/user-details-service.md)
